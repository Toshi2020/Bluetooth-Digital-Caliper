# Bluetooth Digital Caliper  
# デジタルノギスにBluetooth送信機能を追加  

・少し昔のデジタルノギスの中には、データ取り出し用の接点が備わっているタイプがあります。ノギス表示部右上のカバーを開けて基板に4つの接点が見えればデータ出力機能があると考えられます。今回そのデータをBluetooth(BLE)でPCに取り込むユニットを作りました。  
  
 ![全体](https://github.com/user-attachments/assets/aee530c6-9ecf-4d4b-b77e-43c7913a434c)

  
・手持ちのノギスにはデータ出力がなかったので、中古のノギスをメルカリで2種類入手しました。データ出力用のカバーがあることを写真で確認できた100mmと150mmの物を購入しました。調べてみるとこの両者ではデータ用接点の寸法は同じですが、出ている信号が異なりました。  
A:150mmの物は、通常が1.5Vで110ms間隔で0Vのパルス列が出る、こちらで紹介されているタイプ。  
https://www.techno-edge.net/article/2023/05/16/1295.html  
B:100mmの物は、通常が0Vで330ms間隔で1.5Vのパルス列が出る、こちらで紹介されているタイプ  
https://woodgears.ca/tech/caliper/index.html  
  
![ノギス波形](https://github.com/user-attachments/assets/fe4ffed5-4e33-498e-bd03-333109ddf8c3)

・今回はAタイプのパルスに対応した物になります。Bタイプはパルス間隔が狭いので、今回の回路では対応できません。  
・(100mmの物は小型で気に入ったので電源スイッチを追加して持ち歩き用とすることにしました。余談ですが中華製のノギスはオフにしてもLCDが消えるだけで消費電流はほとんど変わらないという事に気付くまでに過去に何個電池を無駄にしたことか、、、)  

**●動作状況の動画はこちら。**  
https://youtu.be/n0HdAyAx71c
  
**●概要などはこちら↓のブログに記述しました。**  
https://minkara.carview.co.jp/userid/3336538/blog/

**●回路**  
 ![CaliperBLE回路](https://github.com/user-attachments/assets/97540937-5580-443c-825c-2c1f47e3df62)

・CR2032のボタン電池でBLE通信したかったのでマイコンボードとしては低消費電流のnRF52840を搭載している小型のXIAO nRF52840 BLEを使いました。最初手持ちのESP32-C3でトライしたのですが、単3電池2本では動くもののボタン電池ではBLE開始で電圧降下してリセットがかかってしまいました。  
・先駆者の皆さんの例ではレベル変換用にNPNトランジスタを使っていますが、nRF52840のアナログ読み取り速度が実測24μsほどで、パルスの最短幅である90μsで3回はサンプルできることから直結としています。(Bタイプのパルスの場合は速度的に間に合わないのでレベル変換とデジタル読み取りが必要です)  
・ノギスの電源は1.5Vで消費電流は19μA程度です。CR2032の3VからLDOを使って作成して供給していますが、一口にLDOといっても入出力の電位差が低いだけで、無負荷電流は品種によって全く異なります。秋月から無負荷電流が2.5μAと小さなLDOのNCP563を調達しました。ただし秋月では電圧が1.8Vの物しか取り扱いがありません。今回のノギスは1.8Vでも問題なく動いているように見受けられたのですが、念のためショットキーダイオードを2つ入れて電圧を下げています。XIAO nRF52840で使われているオンボードLDOはSGM2040だそうですが、こちらの無負荷電流は1μAなので、これの1.5V版が入手できればそれがベストだと思います。  
・ボタン電池側からはボードの3V3端子に給電しています。ボードにはバッテリー接続用のランド(B+とB-)があるのですが、これはリポバッテリーが接続されることを想定しています。リポバッテリーの3.7VやUSBの5Vは3.3VのオンボードLDOを通して3V3端子に供給されるようになっていて、3Vのボタン電池にとってはB+に接続するメリットがありません。ということは電池はオンボードLDOの出力側に接続されることになりますが、LDO SGM2040のデータシートによればVOUT > VINでも逆流しないようになっていて、その時の逆漏れ電流は0.4μA(TYP)ということで入力無し時に出力側に電圧をかけても問題ありません。  
・ボタン電池の内部抵抗は大きいため、BLEの送信に伴ってバッテリー電位が瞬間的にドロップするのが気になったので、3V3端子には470μFの電解コンデンサを入れました。100μFでは物足らない感じでした。  
・ノギスの電源をここから作成すると、BLE未接続状態で電源スイッチをオフにした時に、チャージされた電圧でノギスの表示が長いこと消えないのが違和感があり、ボード側へはショットキーダイオードを通じて給電することにしました。  
・当然ですがUSB接続中は電池は外しておかなくてはいけません。  

**●組み立て**  
・ノギスからの信号取り出しのためのコネクタを作成しました。Thingiverseを検索すると先駆者の方々のコネクタが多々あるのですが、いずれもリード線や樹脂のバネ力で押し付けるタイプのようで、経年変化で接触不良になる可能性が大と判断しました。そこでSATAケーブルのコネクタからバネ接点を取り出して流用しました。瞬間接着剤で1本づつ接点部が少し出っ張るように位置決めして接着し、外側からクリップをはめて接着し、リード線を半田付けしたらピンを優しく90°曲げてからカバーを接着し、ホットボンドで保護しました。  
  
![コネクタ](https://github.com/user-attachments/assets/519ddeed-839a-4c7d-85c8-c9949164c7c4)

・その後ノギス側の形状に合わせたカバーを作って接着しています。一応今回のすべてのパーツを入れたAutodesk Fusionの3DデータCaliperBLE_All.f3dをアップしておきます。  
・今回使ったLDOは表面実装タイプなので、万能基板に半田付けしてXIAOの基板部分に裏向きで乗せています。スイッチはマウス用の物です。オンボードLEDをφ2のアクリル棒で導光しています。いずれもホットボンドで固定しています。ケースは強力両面テープでノギスに張り付けています。  
  
![中身](https://github.com/user-attachments/assets/c860ecfe-1eb9-43ad-a78c-14e03e4a8fce)


**●ソフトウェア**  
・ソースはCaliperBLEフォルダの中にあります。開発環境はArduinoIDEを使っています。  
ArduinoIDEの設定で追加のボードマネージャのURLとして以下を追加し、  
https://files.seeedstudio.com/arduino/package_seeeduino_boards_index.json  
設定では  
ボードマネージャ：Speeed nR52 boards  
ボード:Speeed XIAO nRF52840  
書き込み装置:Bootloadre DFU for Bluefruit nRF52  
とします。  
・別途Pythonのインストールディレクトリを環境変数PATHに設定しておく必要があります。もしPythonが未インストールなら、例えば以下のリンクからダウンロードし  
https://pythonlinks.python.jp/ja/index.html  
Add python.exe to PATHにチェックを入れてインストールしておきます。  
・今回XIAO nRF52840は秋月から購入した物ですが、ブートローダーを焼き直さないと書き込んだソフトが動作しない物がありました。ブートローダーの書き込みもArduinoIDEから行うことができます。  
・シリアルポートが現れないときはボード上の小さなリセットスイッチをダブルクリックします。私は爪楊枝のお尻を使っています。  
  
・ソフトウェアの動作としては、電源オンでノギスへは給電が行われますが本ユニットはシステムオフ(いわゆるディープスリープ)になります。この時の消費電流はnRF52840が約2.2μA、ノギス用LDOが約2.5μAです。BLE接続を行わなければデジタルノギスを単体で使う時とさほど変わらない電流消費ということになります。  
・ここでスイッチを押すと、再起動してBLE接続のためのアドバタイズ動作を開始します。PC側でHIDキーボードデバイスCaliperDataとして検出され、ペアリングしてあれば接続されます。  
・2回目以降はスイッチを押すたびにノギスのデータを送信します。この時押している時間が短いと数値+CRを、0.3秒以上長く押すと数値+TABを送るようにしました。これはCADソフトで数値を入れた後で次の入力フィールドにフォーカスを移動させたり、スプレッドシートで数値記入後に右のセルに移動させるのを可能とするためです。なおinch/mm両方対応しています。  
・BLE接続が30秒以上途絶えたか、スイッチ操作が30分以上なかった場合はいったんシステムオフになり消費電流を押さえます。次回スイッチを押すと再びアドバタイズから開始しますがこの場合は続けて数値を送信します。そのため数値が送られるまで少し間がある挙動になります。  
  
・当初ノギスからのデータとクロックを両方ともADCで読んでいたのですが、nRF52840のデーターシートを見るとLPCOMP(ローパワーコンパレータ)というペリフェラルがあることに気付きました。LPCOMPは1つしかないので、クロック側の読み取りをLPCOMPを使うように変更しました。これで読み取りタイミング的にさらに余裕が出たと思います。  
・nRF52840にはLPCOMPのほかにCOMPというペリフェラルもあるので、データもそちらを使えばより高速に読めるかと思ったのですが、LPCOMPとCOMPは同時使用できないことが分かったのであきらめました。この両者は内部的に共通部分があるようです。  
・電池電圧はanalogReadVDD()という関数で3V3端子のVDD電圧を読んでいます。ADCはデフォルトでは10bit分解能でリファレンスが0.6Vでゲインが1/6なので3.6Vが1024となります。BLEに送るには%に変換しなくてはいけませんが、単純に1.7～3.0Vを0～100%としています。まあ目安なので。  
・システムオフからの復帰の部分とLPCOMPをポーリングで読むやり方などはChatGPTに教わりながら作りました。nRF52840は初めてだったのでAIが大いに役立ちました。ただし以前Webアプリを教わりながら作った時に比べると、AIのnRF52に対する学習量が少ないせいか提示されたコードでは動かないことがままありました。  
・省電力のためにオンボードのflashメモリをスリープさせるやり方はこちらのページの追記(1)からいただきました。  
https://akibabara.com/blog/7539.html  
・XIAOのオンボードflashはP25Q16Hのようです。今回のようにフラッシュにコマンドを送るだけならflashTransportで行けるのですが、試しにフラッシュにアクセスしようとサンプルコードflash_info.inoでflash.begin()を行うと失敗します。これはArduinoIDEのボードライブラリ(1.1.10)のflash_devices.hにP25Q16Hの定義がないためと思われます。そこで先のコード↑にある  
SPIFlash_Device_t const P25Q16H {  
以下の行の構造体をコードに追加してからflash.begin(&P25Q16H, 1)とすればうまくいきました。結果は以下の通りです。  
JEDEC ID: 0x856015  
Flash size: 2048 KB  
  
*★OSベースのマイコンとはこういうものか！*  
・過去に私が使ってきたOSを持たないマイコンは、ハードウェアを直接触れていましたが、nRF52はRTOSがバックグラウンドで最優先で動いています。これにハマりました。BLEを有効にした場合、ユーザー側の処理が長い間待たされることがあるんですね。例えば、  
>```
>// BLE開始
>setup_ble();  
>  
>while(1)  
>{  
>  digitalToggle(D5);  
>}  
>```
とした場合をロジアナで観察した結果、setup_ble()をコメントアウトすると通常3～6μsでループが回り、たまに10μsかかる感じですが、BLEを開始するとそれが最大で123μsにもなることがわかりました。これはおそらくPCとの間でBLEコネクションを確認するための時間だと思われます。これがノギスデータの読み取り中に起きると結果として取りこぼしが発生してしまいます。  
・今までのマイコンならクリティカルな処理の間は割り込みを禁止するのが常套手段でしたが、nRF52でそれをやると例えばADの読み取りができなくなります。ペリフェラルの読み取りもOS側のタスクが行ってユーザープログラムから読めるメモリエリアに結果を書き込んでいるのだと理解しました。  
・仕方ないのでノギス読み取り処理がOS側の処理のために通常よりも時間がかかった場合は、エラーとしてリトライすることにしました。  
・ノギスからのデータは約110msごとなので、リトライすると次のデータが使われるため少し引っかかる感じにはなります。  
・この際時間計測のためにmicros()を使おうとしたのですが、Arduinoではハードウェアのタイマカウンタの値を読み取っているため割り込み等の影響がほぼないのですが、nRF52はこの関数はOS側の値が返されるので時間計測には使えません。そこでChatGPTに教わってDWT->CYCCNTを使うことにしました。  
・ノギスからのパルスが変化しないという前提で、普段よりもパルス幅やADC読み取り時間が大きかった場合にはリトライします。パルス幅はノギスによって異なるでしょうから個別に調整が必要かと思います。また、今回のソフトでもノギスから出ているパルスの幅が変わったりすると読めなくなることになります。ノギスが苦手とする数値があってその数値だけ処理時間が増えてパルス幅が変わったりするとまずいですが検証できていません。  
・また今回のやり方で読み取りエラーが完全に0になるかも検証できていません。  
・またPCとの間の通信インターバルとシンクロしてしまったら永遠にリトライしてしまうかもしれません。  
・そういった意味で不完全な代物だと思っています。  
  
**●互換ボードを評価**  
・XIAO nRF52840は日本だと2,000円近くしますし、Aliexpressでも同程度かもっと高い値段設定です。何だかなぁ～とAliexpressを眺めているうちに互換ボードを発見しました。NologoTechというメーカーのSuper52840というボードで1,200円くらいで入手しました。  
・これはクローンではなく、回路と部品レイアウトが本家XIAOとは微妙に異なるオリジナル品です。ボードのピン配は同じですが、裏面にはIOポート用ランドが9個追加されています。  
https://www.nologo.tech/en/product/keyboard/keyboard_controll/super52840/super528401.html  
・早速使ってみたのですが、結論としては「そのままでは電池動作用としては使えない」です。というのもシステムオフ時の消費電流が700μA近くもあるからです。  
  
・原因の一つがオンボードLDOのRS3236の無負荷電流が大きいことだと思われます。RS3236のデーターシートにはGNDピン電流が50μAとありますがOUT側に流れる無負荷時の電流の記載がありません。このトータルがXIAOのオンボードLDOよりも2桁大きいようです。  
  
![Super52840](https://github.com/user-attachments/assets/37402821-118f-4006-a27b-50192cb8589e)

・LDO RS3236は004ピンの隣にある1mm角の4ピンのチップです。ヒートガンでピンポイントで加熱して針で突いて外したところ電流は170μAまで下がりました。  
・次に怪しいのはオンボードのフラッシュメモリです。JEDEC IDを調べるとW25Q16JV_IQのようです。色々トライしても下がらないのでフラッシュも外そうと気持ちが傾いたのですが、ふと気づいてsetup()でフラッシュのSCKとCSをプルアップしてみたところ、システムオフで1.9μA、delay()ループで4.9μAまで下がりました。オンボードLDOがない分だけXIAOより0.3μA低い値となってます。入力端子がフロートだと中途半端に電流が流れるようです。ということは本家XIAOでもプルアップしておいた方が良さそうです。  
・オンボードLDOを外してしまったので、チップのVDDへ供給する電圧は3V3端子に接続した電池を使っていたのですが、それを忘れてUSBだけで接続してもチップ自体は動作していることに気付きました。3Vを供給していないのでオンボードLEDは点灯できないのですが。この時3V3端子には1.8Vが出ていました。  
・改めて回路図を見ると、この互換ボードはXIAOとは異なりUSB電圧やB+端子のバッテリー電圧がチップのVDDH端子に接続されていることがわかりました。  
  
![電源周り](https://github.com/user-attachments/assets/651cfefb-c7a3-424d-8298-a91521bcc470)

・チップのデーターシートを見ると、VDDが0VでVDDHにのみ電源を供給した場合は自動的に高電圧モードとなり、チップ内のLDO(DCDCも選択可能)が使われることがわかりました。この場合、高電圧モードではVDDは出力となり、チップ内LDOやDCDCで作られた電圧を外部に供給する端子となります。XIAOはVDDとVDDHが直結されているので標準電圧モードにしかなることはできません。  
![パワーマネジメント](https://github.com/user-attachments/assets/cb4e6297-15fb-4a96-ab2c-47c86ca0dbf8)

・LDOを除去した互換ボードでUSB未接続でVDDに電池をつないだ時は、VDDHがオープンなのでデーターシートの図からは外れますが、標準電圧モードで動作しました。この時VDDH端子にはVDD-0.2Vの電圧が観測されました。という事はVDDからVDDHには寄生ダイオード的な物が存在するという事かと思います。  
・そのような使い方をしていいのか調べたところ、次のような書き込みがありました。  
https://devzone.nordicsemi.com/f/nordic-q-a/78756/on-nfr52840-what-are-the-risks-if-the-connection-between-vdd-and-vddh-is-missing-in-normal-power-mode?utm_source=chatgpt.com  
・プロトタイプ的に使う分には問題ないようです。(ちなみに互換ボードではVDDHとVDDに違う電圧を入れていますが、これもデーターシートからは外れたやり方です。万一高電圧モードになってしまったらチップ内のLDOのデフォルトが1.8Vなので3.3Vから逆流してしまう。)  
  
・高電圧モードでのLDOやDCDCの出力はデフォルトで1.8Vですが、不揮発性メモリ(UICR:ユーザー情報設定レジスタ)に書き込むコンフィグデータで設定ができることがわかりました。私は電池動作と同程度となるよう3.0Vに設定してみました。これでオンボードLDOを除去した互換ボードでもUSB接続時に電池なしで周辺を動作させることができます。  
・書き換えは以下のプログラムを実行してリセットを押すと反映されます。2回までしか書き換えられないので慎重に！2か所ある3V0を3V3にすれば3.3V設定です。  
>```
>    if (NRF_UICR->REGOUT0 != UICR_REGOUT0_VOUT_3V0)
>    {
>        // NVMC(不揮発性メモリコントローラ)をライトイネーブルに
>        NRF_NVMC->CONFIG = NVMC_CONFIG_WEN_Wen << NVMC_CONFIG_WEN_Pos;
>        while (NRF_NVMC->READY == NVMC_READY_READY_Busy);   // Ready待ち
>        NRF_UICR->REGOUT0 = UICR_REGOUT0_VOUT_3V0;          // 出力電圧設定
>        // NVMCをリードオンリーに
>        NRF_NVMC->CONFIG = NVMC_CONFIG_WEN_Ren << NVMC_CONFIG_WEN_Pos;
>        while (NRF_NVMC->READY == NVMC_READY_READY_Busy);   // Ready待ち
>    }
>```
  
・データーシートによればnRF52840のシステム自体は2段目のLDOまたはDCDCで作成した1.3Vで動いています。DCDCを動かすためには外付けのLCが必要なのですが、XIAOも互換ボードも2段目にLCを持っています。何もしなければ2段目はLDOが使われますが、起動後にDCDCに設定した方がよりエコになるかと思います。スリープ電流的には変わりなかったですがBLE通信で電流が必要となった時に効いてくるはずです。パルス状なのでDMMでは読み取れませんが。  
・1段目は互換ボードにのみLCがあります。LDOを外した互換ボードをリポバッテリーで動かすならこちらもDCDCを選択した方が良いですね。XIAOはそもそも高電圧モードに切り替わらないので1段目は関係ありません。  
・互換ボードでB+端子に電池をつないでチップ内の1段目のLDOまたはDCDCを生かした場合と、3V3端子へ直接電池をつないだ場合とを比較すると、前者の方が供給電流が40μAほど大きいです。これはチップ内LDOやDCDCの無負荷電流分でしょうが、XIAOがチップ内LDOを使わずにわざわざLDOを外付けにしたのはそういった理由なんでしょうね。  
・参考までにnRF52840のデータシートではVDDに供給する場合の電圧範囲は1.7～3.6V、VDDHの場合は2.5～5.5Vとなっています。VDDHはリチウムバッテリーやUSBを直結することを考えて作られているんですね。  
・(しかしこんな柔軟な設定ができるチップを考えたり作ったりした人達は天才集団ですね！RTOSベースで動いていて一般的なCPUだとdelay()は時間が来るまで無駄にループをグルグル回るだけでしたが、このチップはOS側に制御が渡ってスリープするので消費電流が5μA程度まで落ちるのもすごいです。)  
  
**●収納ケースも改造してみた**  
・表示部の厚さが倍増してしまったので、元のケースに穴を開けて後ろ側にカバーを接着しました。同じ高さになるように足も追加しています。  
  
![収納ケース](https://github.com/user-attachments/assets/6f38ae93-d404-43d5-974e-bbeb6f0d2d65)

  
**●今思うと**  
・ノギス本体を無改造とするためにデータ用のコネクタを作成しましたが、ノギスの改造を是とするならば、直接半田付けして信号線を引き出しても良かったかもしれません。  
・電源を入れた時に470μFにチャージ電流が流れるのでボタン電池の内部抵抗により3Vは徐々に立ち上がります。それが原因かもしれないのですが、最初の通電時のノギスの表示が極端に大きな値となってしまいます。ZEROボタンの信号線も引き出して、通電直後に信号を送って初期値を0.00にクリアすると気分がいいかもしれません。測定前に0位置を確認してから手動でZEROボタンを押す手間が減るわけではないのですが。  
・省スペースのためレベル変換回路を持たない構成としましたが、チップ部品を使えば同じ場所に収まると思うので、そうすればノギスからのデータはデジタル的に読めます。その場合ChatGPTによればTIMER→ GPIO → PPI → TIMER CAPTUREという流れにすればCPUを介さずに読み取れるとのことなので、今回のようにエラーが起きたらリトライ、などという力技を使わないで済みます。  
・実はこの製作は2号機で、1号機はノギス側はATtiny85で読み取って値を赤外線LEDで1200bpsで送り、受信ユニットはESP32C3でリモコン用の光モジュールで受けてPCにBLEで送る、というものでした。受信ユニットが別途必要なので、ノギスから直接BLE送信した方がスマートかなと思い今回の2号機を作成しました。でも結果としてソフト的には1号機の方がスマートだったかな、と思います。  
  
以上です。  
